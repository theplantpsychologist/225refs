<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <!-- <p>Introduction</p>
    <h1>Header1</h1> -->
    <noscript>Please enable javascript to use this app.</noscript>
    <div>            
        <script src="origami.js"></script>
        <script src="paper-core.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/10.0.0/math.min.js"></script>   
        <script type="importmap">
            {
            "imports": {
                "three": "https://unpkg.com/three@v0.157.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@v0.157.0/examples/jsm/"
            }
            }
        </script>
        <p>Upload a .FOLD file (with all vertices in the unit square). Select whether you would like the vertex coordinates to be in the form (a + b sqrt(2))/c, or in 4 dimensional (x,y,z,w) form.  </p>
        <input type="file" id="inputfile" name="inputfile" value="example.cp" />
        <pre id="output"></pre>
        <script>
            let abc_table = {};
            // Fetch the JSON file and store it in abc_table
            fetch('./abc_table.json')
                .then(response => response.json())
                .then(data => {
                    abc_table = data;
                })
                .catch(error => console.error('Error loading JSON:', error));
            function dec2abc(abcTable, target) {
                const keys = Object.keys(abcTable).map(parseFloat);
                //Binary search, using initial estimate of the index assuming an even distribution of keys
                let left = Math.max(0)//,keys.length * target - 10000);
                let right = Math.min(keys.length-1)//,keys.length * target + 10000);
                while (left < right) {
                    const mid = Math.floor((left + right) / 2);
                    if (keys[mid] === target) {
                        if (keys[mid] === 0) {
                            return [0,0,1]
                        } else if (keys[mid] ==1){
                            return  [1,0,1]
                        }
                        else {return abcTable[keys[mid]]};
                        // console.log(`top target:${target},closestkey:${mid},output:${abcTable[keys[mid]]}`)
                        // break
                        // return abcTable[keys[mid]];
                    } else if (keys[mid] < target) {
                        left = mid + 1;
                    } else {
                        right = mid;
                    }
                }

                // After the loop, left should be the closest index
                const closestKey = (left === 0 || (left < keys.length && Math.abs(keys[left] - target) < Math.abs(keys[left - 1] - target))) ? keys[left] : keys[left - 1];
                if (closestKey === 0) {
                    output = [0,0,1]
                } else if (closestKey ==1){
                    output =  [1,0,1]
                }
                else {output = abcTable[closestKey]};
                // console.log(`bottom target:${target},closestkey:${closestKey},output:${output}`)
                return output
            }
            function abc2xyzw(ax,bx,cx,ay,by,cy){
                return [ax/cx, bx/cx + by/cy, ay/cy,-bx/cx + by/cy]
            }
            function gcd(a, b) {
                return b === 0 ? a : gcd(b, a % b);
            }
            function floatToFraction(float) {
                const floatStr = float.toString();
                const decimalPlaces = floatStr.includes('.') ? floatStr.split('.')[1].length : 0;
                const denominator = Math.pow(10, decimalPlaces);
                const numerator = Math.round(float * denominator);
                const commonDivisor = gcd(numerator, denominator);

                if(numerator ==0){return 0}
                if(denominator/commonDivisor == 1){return numerator / commonDivisor}
                return `${numerator / commonDivisor}/${denominator / commonDivisor}`
            }
        </script>
        <script type="module">
            // import {display3d} from './main.js';
            import {UploadFold} from './main.js';
            // document.addEventListener('DOMContentLoaded', (event) => {
            //     test3d();
            // });
            var cpObject
            document.getElementById("upload").onclick = function(){
                cpObject = UploadFold();
                // console.log(cpObject,"it's an object!!!!")
            };
        </script>
        <!-- <button id="upload" type=button onclick="UploadCp()">UploadCp</button> -->
        <div>
            <p>Vertex annotation:</p>
            <input type="radio" id="abcForm" name="displayOption" value="abcForm">
            <label for="abcForm">Coordinates in a b c form</label><br>
            <input type="radio" id="xyzwForm" name="displayOption" value="xyzwForm">
            <label for="xyzwForm">Coordinates in (x,y,z,w) form</label><br>
        </div>
        <button id="upload" type=button onclick="UploadFold()">Render .FOLD file</button>
    </div>
    <div style="display: flex;">
        <div style="display: table-cell;border:1px solid black">
            <canvas id="square" width="600" height="600" style="background-color: white;"></canvas>
            <script type="text/javascript" data-paper-ignore="true">
                paper.setup(document.getElementById("square"))
                var displaycp = new paper.Group();
            </script>
        </div>
        <div id="3dCanvas" style="height: 600px; border: 1px solid black;"></div>
            <!-- <input type="range" min="0" max="180" value="90" id="theta">
            <p>Slider Value: <span id="sliderValue">90</span></p>
            <script type="module">
                import {display3d} from './main.js';
                const slider = document.getElementById("theta");
                const sliderValue = document.getElementById("sliderValue");
                slider.addEventListener("input", function() {
                    sliderValue.textContent = this.value;
                    display3d(cpObject)
                });
            </script> -->
        </div>
    </div>
</body>
</html>