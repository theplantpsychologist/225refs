<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <!-- <p>Introduction</p>
    <h1>Header1</h1> -->
    <noscript>Please enable javascript to use this app.</noscript>
    <p>Upload a .FOLD file and it will convert the coordinates into (a+b sqrt2)/c form</p>
    <div>               
        <input type="file" id="inputfile" name="inputfile" value="example.cp" />
        <pre id="output"></pre>
        <script>
            let abc_table = {};
            // Fetch the JSON file and store it in abc_table
            fetch('./abc_table.json')
                .then(response => response.json())
                .then(data => {
                    abc_table = data;
                })
                .catch(error => console.error('Error loading JSON:', error));
            function dec2abc(abcTable, target) {
                const keys = Object.keys(abcTable).map(parseFloat);
                //Binary search, using initial estimate of the index assuming an even distribution of keys
                let left = Math.max(0)//,keys.length * target - 10000);
                let right = Math.min(keys.length-1)//,keys.length * target + 10000);
                while (left < right) {
                    const mid = Math.floor((left + right) / 2);
                    if (keys[mid] === target) {
                        if (keys[mid] === 0) {
                            return [0,0,1]
                        } else if (keys[mid] ==1){
                            return  [1,0,1]
                        }
                        else {return abcTable[keys[mid]]};
                        // console.log(`top target:${target},closestkey:${mid},output:${abcTable[keys[mid]]}`)
                        // break
                        // return abcTable[keys[mid]];
                    } else if (keys[mid] < target) {
                        left = mid + 1;
                    } else {
                        right = mid;
                    }
                }

                // After the loop, left should be the closest index
                const closestKey = (left === 0 || (left < keys.length && Math.abs(keys[left] - target) < Math.abs(keys[left - 1] - target))) ? keys[left] : keys[left - 1];
                if (closestKey === 0) {
                    output = [0,0,1]
                } else if (closestKey ==1){
                    output =  [1,0,1]
                }
                else {output = abcTable[closestKey]};
                // console.log(`bottom target:${target},closestkey:${closestKey},output:${output}`)
                return output
            }
        </script>
        <script>
            function UploadFold() {
                paper.project.clear();
                const reader = new FileReader();
                reader.onload = function () {
                    input = reader.result;
                    //load the cp
                    cpObject = readFoldFile(input);
                    console.log(cpObject)
                    for (const vertex of cpObject.vertices) {
                        // var x = vertex.x
                        vertex.xabc = dec2abc(abc_table, vertex.x);
                        vertex.yabc = dec2abc(abc_table, vertex.y);
                    }
                    console.log("abc coords calculated")
                    //display the cp 
                    displayCp(cpObject,50,50,750,750,false,true);

                };
                const fileSelector = document.getElementById("inputfile");
                if (fileSelector) {
                    reader.readAsText(fileSelector.files[0]);
                } else {
                    console.log("File input element not present");
                }
            }
        </script>
        <!-- <button id="upload" type=button onclick="UploadCp()">UploadCp</button> -->
        <button id="upload" type=button onclick="UploadFold()">UploadFold</button>
    </div>
    <canvas id="square" width="800" height="800"></canvas>
    <script src="origami.js"></script>
    <script src="paper-core.js"></script>
    <script type="text/javascript" data-paper-ignore="true">
        paper.setup(document.getElementById("square"))
        var displaycp = new paper.Group();
    </script>
</body>
</html>